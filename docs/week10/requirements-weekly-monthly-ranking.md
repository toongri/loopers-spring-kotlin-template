# 요구사항 분석 문서: 주간/월간 랭킹 시스템

## 1. 프로젝트 개요

### 1.1 해결하고자 하는 문제

현재 시스템은 실시간(시간대별) 랭킹과 일간 랭킹만 제공하고 있어, 순간적인 트렌드는 파악할 수 있지만 꾸준히 인기 있는 상품을 파악하기 어렵다. 구매자가 거시적인 트렌드를 확인하고 검증된 인기 상품을 탐색할 수 있도록 주간 및 월간 랭킹을 제공하고자 한다.

### 1.2 프로젝트 목표

기존 일간 메트릭 데이터를 기반으로 주간(최근 7일) 및 월간(최근 30일) 랭킹을 집계하여 제공한다. Spring Batch를 활용한 배치 처리로 매일 랭킹을 갱신하고, 관리자가 필요시 수동으로 배치를 실행하거나 재집계할 수 있도록 한다.

### 1.3 기대 효과

검증된 인기 상품 노출을 통해 구매자의 구매 의사결정을 지원한다. 실시간/일간 랭킹은 "지금 뜨는" 상품을 보여주지만 반짝 인기에 그칠 수 있다. 주간/월간 랭킹은 일정 기간 동안 꾸준히 인기 있는 상품을 보여줌으로써 구매자가 더 신뢰도 높은 의사결정을 할 수 있도록 돕는다.

### 1.4 프로젝트 완성 조건

본 프로젝트는 다음 조건을 모두 만족할 때 완성된 것으로 간주한다.

첫째, 모든 유스케이스(US-1 ~ US-4)의 인수 조건을 통과해야 한다. 둘째, 모든 비기능 요구사항(섹션 5)의 조건을 만족해야 한다.

---

## 2. 도메인 용어집

| 용어 | 정의 |
|-----|-----|
| 실시간 랭킹 | 현재 시간대(1시간)와 이전 시간대 이월분(10%)을 합산한 인기도 기준 상품 순위. 실질적으로 약 2시간 범위의 행동이 반영됨 |
| 일간 랭킹 | 특정 날짜 하루 동안의 인기도를 기준으로 매겨진 상품 순위 |
| 주간 랭킹 | 기준일로부터 최근 7일간의 인기도 합산을 기준으로 매겨진 상품 순위 |
| 월간 랭킹 | 기준일로부터 최근 30일간의 인기도 합산을 기준으로 매겨진 상품 순위 |
| 기준일 | 랭킹 집계의 기준이 되는 날짜. 해당 날짜는 집계에 포함되지 않음 |
| 집계 윈도우 | 랭킹 계산을 위해 데이터를 수집하는 기간. 주간은 7일, 월간은 30일 |

### 2.1 비즈니스 규칙

**주간/월간 인기도 계산:**

주간 및 월간 인기도는 해당 기간 내 일간 메트릭(조회수, 좋아요수, 주문금액)을 각각 취합한 뒤 가중치를 적용하여 계산한다. 기존 가중치 체계(조회 0.10, 좋아요 0.20, 주문금액 0.60)를 그대로 사용한다.

**예시:** 상품 A의 최근 7일간 일간 메트릭이 조회 총 1,000회, 좋아요 총 50개, 주문금액 총 100,000원이라면, 주간 인기도 점수는 (1,000 × 0.10) + (50 × 0.20) + (100,000 × 0.60) = 60,110점이다.

**집계 기준일:**

랭킹 집계는 기준일 전일까지의 데이터를 사용한다. 기준일 당일 데이터는 포함되지 않는다. 이는 당일 데이터가 아직 완전하지 않기 때문이다.

**예시:** 1월 2일 기준 주간 랭킹은 12월 26일부터 1월 1일까지의 데이터를 집계한다.

**Rolling 윈도우:**

주간 랭킹은 최근 7일, 월간 랭킹은 최근 30일의 데이터를 사용한다. 자연주/자연월이 아닌 Rolling 방식을 사용하여 매일 갱신되는 실시간성 높은 랭킹을 제공한다. Rolling 방식은 항상 전체 윈도우 데이터가 존재하므로 이전 기간 이월이 필요 없다.

**Fallback 정책:**

당일 기준 랭킹이 아직 집계되지 않은 경우, 전날 기준 랭킹을 제공한다. 이를 통해 배치 실행 전이나 배치 실패 시에도 사용자에게 랭킹을 보여줄 수 있다.

**TOP 100 제한:**

주간/월간 랭킹은 상위 100개 상품만 저장하고 제공한다. 100위 밖 상품은 랭킹 목록에 포함되지 않는다.

**실행 주기 제한:**

배치는 정해진 주기 내에서 정상 실행되며, 주기를 초과한 실행은 실패 복구만 수행한다.

- 실시간 배치: 30분에 한 번
- 일간 배치: 12시간에 한 번
- 주간/월간 배치: 하루에 한 번

---

## 3. 주요 사용자와 목표

### 3.1 구매자

구매자는 주간/월간 인기 상품 랭킹을 조회하여 순간적인 트렌드가 아닌 꾸준히 인기 있는 상품을 탐색하고자 한다. 또한 과거 특정 시점의 랭킹을 조회하여 해당 시점에 어떤 상품이 인기 있었는지 확인하고자 한다.

### 3.2 관리자

관리자는 배치 작업 상태를 확인하고, 필요시 수동으로 실행하거나 재집계하고자 한다. 배치 실패 시 재실행하거나 특정 날짜 기준으로 다시 집계할 수 있어야 한다.

---

## 4. 유스케이스 명세

### US-1: 주간/월간 랭킹 조회

**사용자 스토리:**

구매자로서 주간 또는 월간 인기 상품 랭킹을 조회하고 싶다. 그래야 순간적인 트렌드가 아닌 꾸준히 인기 있는 상품을 탐색할 수 있다.

**인수 조건:**

1. 기간 타입(실시간/일간/주간/월간)을 지정하여 랭킹을 조회할 수 있다
2. 기간 타입을 지정하지 않으면 실시간 랭킹이 제공된다
3. 랭킹은 인기도 점수가 높은 순으로 정렬된다
4. 랭킹에 상품 정보(상품명, 가격, 재고, 좋아요 수)가 함께 제공된다
5. 한 번에 조회되는 상품 수를 지정할 수 있다 (1~100)
6. 다음 순위의 상품들을 이어서 조회할 수 있다 (페이지네이션)
7. 주간/월간 랭킹은 최대 100위까지 제공된다
8. 100위 이후를 요청하면 빈 목록이 반환된다
9. 당일 기준 랭킹이 집계되지 않은 경우 전날 기준 랭킹이 제공된다
10. Fallback 랭킹도 없으면 빈 목록이 반환된다

**예외 상황:**

1. 기간 타입이 유효하지 않은 경우 시스템이 요청을 거부한다
2. 한 번에 조회할 상품 수가 허용 범위(1~100)를 벗어난 경우 시스템이 요청을 거부한다

---

### US-2: 과거 시점 랭킹 조회

**사용자 스토리:**

구매자로서 특정 날짜 기준의 주간/월간 랭킹을 조회하고 싶다. 그래야 과거 특정 시점에 어떤 상품이 인기 있었는지 확인할 수 있다.

**인수 조건:**

1. 기준일을 지정하여 해당 날짜 기준의 랭킹을 조회할 수 있다
2. 기준일을 지정하지 않으면 오늘 기준 랭킹이 제공된다
3. 미래 날짜를 지정하면 오늘 기준으로 대체된다
4. 주간/월간 랭킹은 집계된 데이터가 있는 한 과거 조회가 가능하다
5. 실시간 랭킹은 TTL 2시간, 일간 랭킹은 TTL 이틀이므로 그 이전 데이터는 빈 목록이 반환된다
6. 해당 기준일에 집계 데이터가 없으면 빈 목록이 반환된다
7. 나머지 조회 동작(정렬, 상품 정보, 페이지네이션 등)은 US-1과 동일하다

**예외 상황:**

1. 기준일 형식이 잘못된 경우 시스템이 요청을 거부한다

---

### US-3: 배치 수동 실행

**사용자 스토리:**

관리자로서 배치 작업을 수동으로 실행하고 싶다. 그래야 배치 실패 후 재실행하거나 특정 날짜 기준으로 재집계할 수 있다.

**인수 조건:**

1. 관리자는 실시간/일간/주간/월간 랭킹 배치를 수동으로 실행할 수 있다
2. 기준일을 지정하여 해당 날짜 기준으로 집계할 수 있다
3. 기준일을 지정하지 않으면 오늘 기준으로 집계한다
4. 미래 날짜를 지정하면 오늘 기준으로 대체된다
5. 배치 실행은 동기로 동작하며 완료될 때까지 기다린다
6. 배치 실행 결과(성공/실패)를 확인할 수 있다
7. 이미 집계된 날짜를 재실행하면 기존 데이터를 덮어쓴다
8. 동일 배치가 이미 실행 중이면 중복 실행되지 않는다
9. 실행 주기 제한을 초과하면 자동으로 실패 복구 모드로 전환된다
10. 실패 복구 모드에서는 이전 실행에서 실패한 항목만 재처리한다
11. 복구할 실패 항목이 없으면 성공으로 종료되며 해당 메시지가 반환된다

**예외 상황:**

1. 동일 배치가 이미 실행 중인 경우 시스템이 요청을 거부한다

---

### US-4: 배치 모니터링

**사용자 스토리:**

관리자로서 배치 작업의 실행 상태를 확인하고 싶다. 그래야 배치가 정상적으로 동작하는지 파악하고 문제 발생 시 대응할 수 있다.

**인수 조건:**

1. 배치 실행 시작 시 로그에 시작 시간이 기록된다
2. 배치 실행 완료 시 로그에 종료 시간이 기록된다
3. 배치 실행 완료 시 로그에 read 건수가 기록된다
4. 배치 실행 완료 시 로그에 write 건수가 기록된다
5. 배치 실행 실패 시 로그에 실패 사유가 기록된다

**예외 상황:**

N/A: 로그 기반 모니터링으로 별도 예외 상황 없음

---

## 5. 비기능 요구사항

### 5.1 시스템 안정성

배치 실행 중 시스템이 종료되어도 데이터가 유실되지 않고 재시작 후 이어서 처리할 수 있어야 한다.

**검증 기준:** 배치가 100개 상품 중 50개를 처리한 시점에 시스템이 종료되면, 재시작 후 나머지 50개 상품부터 이어서 처리된다.
